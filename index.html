<!DOCTYPE html>
<html>
  <head>
    <title>TestErr</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <link rel="stylesheet" type="text/css" href="css/jTinder.css">
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script type="text/javascript" src="js/jquery.transform2d.js"></script>
    <script type="text/javascript" src="js/jquery.jTinder.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <style>
     .axis path,
     .axis line {
	 fill: none;
	 stroke: grey;
	 stroke-width: 1;
	 shape-rendering: crispEdges;
     }
    </style>
  </head>
  <body>


    <div data-role="page" id="page1">

      <div data-role="popup" id="welcome" data-overlay-theme="b" data-theme="b" data-position-to="window" data-history="false">
	<div data-role="header">
	  <h1>Welcome</h1>
	</div><!-- /header -->
	<div role="main" class="ui-content" data-history="false">
	  <p>Your task is to interpret and act upon the results of a test of positive (implying disease) vs negative (healthy) status.</p>
	  <p>Two bars represent a pos<span style="color:red; font-weight:bold">i</span>t<span style="color:red; font-weight:bold">i</span>ve test, one bar a negat<span style="color:red; font-weight:bold">i</span>ve result. But the result isn't 100% sensitive, so your patient might have the disease even given a negative result. Nor is it completely specific so your patient may be healthy despite getting a positive result.</p>
	  <p>You can diagnose a patient to be healthy by <span style="color:green">swiping right</span>.  Swipe <span style="color:red"> left</span> to indicate you believe the patient has the disease.</p>
	  <p>Either choice you make can be right or wrong. In science mistakes only become apparent after further tests - here you'll get the full impact of mistakes immediately!</p>
	  <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">OK</a>
	</div>
      </div>

      <div data-role="header">
	<h1>TestErr</h1>
	<div id="progress" style="height:5px;width:0%;background-color:green"></div>
      </div><!-- /header -->

      <div role="main" class="ui-content">
	<div class="wrap">
	  <div id="tinderslide">
            <ul>
	      <li class="pane1">
		<h3 id="last_result" class="ui-bar ui-bar-a ui-corner-all"></h3>
		<div id="outcome" class="ui-body"></div>
		<input type="image" src="img/continue.png" onclick='$("#tinderslide").jTinder("like");' />
	      </li>
              <li class="pane2">
		<svg
		    id="SVG_plot"
		    version="1.1"
		    viewBox="0 0 100 40"
		    width="100%">
		  <text
		      xml:space="preserve"
		      style="font-style:normal;font-weight:normal;font-size:2.8px;line-height:1.25;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;display:inline;fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.26458332"
		      x="42.012325"
		      y="11.112646"
		      id="controlstr"><tspan
					  id="tspan994"
					  x="42.012325"
					  y="11.112646"
					  style="font-size:2.8px;stroke-width:0.26458332">Control</tspan></text>
		  <text
		      xml:space="preserve"
		      style="font-style:normal;font-weight:normal;font-size:2.8px;line-height:1.25;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;display:inline;fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.26458332"
		      x="59.674431"
		      y="11.020315"
		      id="teststr"><tspan
				       id="tspan994-8"
				       x="59.674431"
				       y="11.020315"
				       style="font-size:2.8px;stroke-width:0.26458332">Test</tspan></text>
		  <rect
		      style="display:inline;fill:none;stroke:#000000;stroke-width:0.23728547;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
		      id="boundary"
		      width="71.216873"
		      height="27.970238"
		      x="11.919201"
		      y="5.5472617"
		      ry="6.2366071" />
		  <path
		      style="display:inline;fill:none;stroke:#000000;stroke-width:0.22699943;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
		      d="M 83.35504,27.290543 H 27.380029 c -2.533007,0 -4.572218,-2.783962 -4.572218,-6.242062 V 5.5379035"
		      id="rim" />
		  <rect
		      style="display:inline;fill:none;stroke:#000000;stroke-width:0.26499999;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
		      id="window"
		      width="37.041672"
		      height="6.0476227"
		      x="36.98518"
		      y="13.976156" />
		  <rect
		      style="display:inline;fill:#ff0000;stroke:#000000;stroke-width:0.20171277;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
		      id="control"
		      width="2.7091205"
		      height="6.1109066"
		      x="45.749615"
		      y="13.94451" />
		  <rect
		      style="display:inline;fill:#ff0000;stroke:#000000;stroke-width:0.20171277;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
		      id="test"
		      width="2.7091205"
		      height="6.1109066"
		      x="61.142784"
		      y="13.94451" />
		</svg>
		<div class="like"></div>
                <div class="dislike"></div>
	      </li>
	    </ul>
	  </div>
	</div>
      </div><!-- /content -->
      <div data-role="footer">
	<h4>Latest Info</h4>
	<p>You are currently <span class="player_status"></span>, and have a reputation of <span id="player_reputation"></span>.</p>
	<p class="player_descrip"></p>
      </div><!-- /footer -->

      <div data-role="popup" id="popupDialog" data-overlay-theme="b" data-theme="b" style="max-width:400px;" data-history="false">
	<div data-role="header">
	  <h1>Congratulations</h1>
	</div><!-- /header -->
	<div role="main" class="ui-content">
	  <p>Well done, your reputation is now high enough that you've been promoted to <span class="player_status"></span>.
	    <span class="player_descrip"</span>
	  </p>
	  <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">OK</a>
	</div>
      </div>

      
    </div><!-- /page -->
    
    
    
    <script>
     var player_state = {level:"Unsymptomatic",
			 reputation:10,
			 max_reputation:10
     };
     var posOrNeg;
     var level_lookup = {descrip: {Unsymptomatic: "Your patient has no symptoms",
				   Symptomatic: "Your patient has a disease symptom ",
				   Keyworker: "Your patient works in an environment with a moderate exposure to others with the disease, and is not in self isolation",
				   Medic: "You work in an environment with a high exposure to others"},
			 status: {Unsymptomatic: "Level 1",
				  Symptomatic: "Level 2",
				  Keyworker: "Level 3",
				  Medic: "Level 4"},
			 threshold: {Unsymptomatic: 10,
				     Symptomatic: 20,
				     Keyworker: 30,
				     Medic: 40},
			 promotion: {Unsymptomatic: "Symptomatic",
				     Symptomatic: "Keyworker",
				     Keyworker: "Medic",
				     Medic: "Winner"},
			 pPos: {Unsymptomatic: .5,
				Symptomatic: .5,
				Keyworker: .5,
				Medic: .5
			 },
			 trueNeg: {Unsymptomatic: {rep:5,msg:"Correct - The test worked and your patient is healthy"},
				   Symptomatic: {rep:1,msg:"Correct - There are many causes of the observed symptom, you were right to rely on the test this time."},
				   Keyworker: {rep:1,msg:"Correct - Even increased exposure doesn't necessarily lead to disease."},
				   Medic: {rep:1,msg:"Correct - Always a relief to give a colleague good news"}},
			 
			 falsePos: {Unsymptomatic: {rep:-1,msg:"The test misled you - there's a lot of people with no symptoms, and because the test isn't 100% specific, some will result in a false positive test result. The patient will over-cautiously self-isolate, so not too much harm done"},
				    Symptomatic: {rep:-2,msg:"You put too much faith in the test - even with patients presenting with the symptoms, there's still a chance the test is wrong. Wouldn't it be nice to have a better test."},
				    Keyworker: {rep:-5,msg:"The patient self-isolated, but the disease never progressed. They couldn't do their key job, and let's hope they don't think they're now immune."},
				    Medic: {rep:-5,msg:"Your colleague never really trusted your skills, and a second opinion with a better test revealed they didn't have the disease, so they returned to work, but your reputation has gone down."}},
			 
			 truePos: {Unsymptomatic: {rep:3,msg:"Your patient has the disease, and the test agreed. Well done Dr."},
				   Symptomatic: {rep:3,msg:"An easy case to diagnose, symptoms and a positive test - but don't get over-confident."},
				   Keyworker: {rep:5,msg:"This person could have been a super-spreader, so well done on detecting the disease."},
				   Medic: {rep:5,msg:"Another colleage adversely affected. So sad and worrying, but you did a good job anyway."}},
			 
			 falseNeg: {Unsymptomatic: {rep:-3,msg:"Wrong. Despite showing no symptoms, and the test proving negative, the patient has the disease. This is a costly mistake as the patient may spread the disease more widely, but without a more sensitive test there's not much you could have done!"},
				    Symptomatic: {rep:-5,msg:"Sometimes you should trust your medical instincts, rather than rely on an imperfect test. Wouldn't it be good if the test was more informative - maybe someone should invent a test that reports probablity of disease, so you could use your medical expertise more easily."},
				    Keyworker: {rep:-10,msg:"Your patient has had exposure to the disease - this time it would have been better to play it safe and over-rule the test results. Who know's how many people they have spread it to?"},
				    Medic: {rep:-2,msg:"It was bound to happen, misdiagnosing one of your colleagues is never good - better hope you administered the test correctly and it was just bad luck that they mistakenly tested negative. But even so, perhaps you should have carried out an independent test before clearing them."}},

			 label_accept: {Unsymptomatic: "Submit coursework",
					Symptomatic: "Submit thesis chapter",
					Keyworker: "Submit journal paper",
					Medic: "Investigate further"}
     };
     function reveal_result(event) {
	 // Will replace this with flag from dataset
	 var correct = (posOrNeg==event.data.obs)?"true":"false";
	 var outcome = level_lookup[correct + event.data.obs][player_state.level];
	 var pn={trueNeg:"True Negative", falseNeg:"False Negative", truePos:"True Positive", falsePos:"False Positive"};
	 var t0=d3.select("#last_result").transition().style("background-color","#E9E9E9").text("Last Result - " + pn[correct+event.data.obs]);
	 t0.transition().style("background-color", (correct=="true")?"#CCEBC5":"#FBB4AE");
	 $("#outcome").text(outcome.msg);
	 player_state.reputation += outcome.rep;
	 $("#player_reputation").text(Math.floor(player_state.reputation));
	 $("#progress").animate({width:100*player_state.reputation/(level_lookup.threshold[player_state.level]) + "%"});
	 if (player_state.reputation >= level_lookup.threshold[player_state.level]) {
	     $("#popupDialog").popup("open");
	     player_state.level = level_lookup.promotion[player_state.level];
	     $(".player_status").text(level_lookup.status[player_state.level]);
	     $(".player_descrip").text(level_lookup.descrip[player_state.level]);
	     $("#accept").text(level_lookup.label_accept[player_state.level]);
	 }
     }
     var margin = {top: 10, right: 50, bottom: 50, left: 50}
       , width = window.innerWidth - margin.left - margin.right-10
       , height = window.innerHeight/3 - margin.top - margin.bottom;
     d3.select("#SVG_plot")
       .attr("width", width + margin.left + margin.right)
       .attr("height", height + margin.top + margin.bottom)
     $(".wrap").height(300);
     var svg;
     function plot_chart() {
	 posOrNeg = (Math.random() <level_lookup.pPos[player_state.level] )?"Pos":"Neg";
	 if (posOrNeg=="Pos") {
	     $("#test").show();
	 } else {
	     $("#test").hide();
	 }
     }
     
     $(function(){
	 $("#tinderslide").jTinder({
	     // dislike callback
	     onDislike: function (item) {
		 if (item.hasClass("pane2")) {
		     reveal_result({data:{obs:"Pos"}});
		 } else {
		     plot_chart();
		 }
	     },
	     // like callback
	     onLike: function (item) {
		 if (item.hasClass("pane2")) {
		     reveal_result({data:{obs:"Neg"}});
		 } else {
		     plot_chart();
		 }
	     },
	     animationRevertSpeed: 200,
	     animationSpeed: 400,
	     threshold: 1,
	     likeSelector: '.like',
	     dislikeSelector: '.dislike'
	 });

	 /**
	  * Set button action to trigger jTinder like & dislike.
	  */
	 $('.actions .like, .actions .dislike').click(function(e){
	     e.preventDefault();
	     $("#tinderslide").jTinder($(this).attr('class'));
	 });
	 $(".player_status").text(level_lookup.status[player_state.level]);
	 $(".player_descrip").text(level_lookup.descrip[player_state.level]);
	 $("#player_reputation").text(player_state.reputation);
	 $( "#popupDialog" ).on( "popupafterclose", function( event, ui ) {$("#progress").animate({width:100*player_state.reputation/(level_lookup.threshold[player_state.level]) + "%"})} );
	 /* 
	    $("#accept" ).click({obs:"Pos"}, reveal_result);
	    $("#reject" ).click({obs:"Neg"}, reveal_result);
	  */
	 /* d3.select("#SVG_plot")
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", height + margin.top + margin.bottom);
	    d3.select("#SVG_plot g")
	    .attr("transform", "translate(" + margin.left + "," + margin.top + ")"); */
	 plot_chart();
     });
     $(document).on("pageshow","#page1", function(){
	 $('#welcome').popup('reposition', 'positionTo: window');
	 $("#welcome").popup("open");
	 
	 $("#welcome").on( "popupafterclose", function( event, ui ) {
	     $("#progress").animate({width:100*player_state.reputation/(level_lookup.threshold[player_state.level]) + "%"});
	     $(".pane2")
		 .animate({left:+200},  {step:function( now, fx ) {$( ".like" ).css( "opacity", now/200 );}})
		 .animate({left:+0},  {step:function( now, fx ) {$( ".like" ).css( "opacity", now/200 );}})
		 .animate({left:-200},  {step:function( now, fx ) {$( ".dislike" ).css( "opacity", -now/200 );}})
		 .animate({left:+0},  {step:function( now, fx ) {$( ".dislike" ).css( "opacity", -now/200 );}})
	 });
     });
    </script>
  </body>
</html>
